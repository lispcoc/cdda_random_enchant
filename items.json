[
  {
    "id": "enchant_crystal",
    "type": "TOOL",
    "category": "spare_parts",
    "name": { "str": "エンチャント・クリスタル" },
    "conditional_names": [ { "type": "FLAG", "condition": "random_enchant_USED", "name": { "str_sp": "%s(使用済)" } } ],
    "description": "武器に特殊な力を付与することのできる結晶です。一度使用すると力を失います。",
    "weight": "5 g",
    "volume": "250 ml",
    "price": 1500,
    "symbol": "=",
    "color": "yellow",
    "looks_like": "battery",
    "use_action": {
      "type": "effect_on_conditions",
      "description": "Seems like a targeted spatial distortion.",
      "effect_on_conditions": [
        {
          "id": "EOC_random_enchant_enchant_crystal",
          "condition": { "not": { "npc_has_flag": "random_enchant_USED" } },
          "effect": [
            { "run_eocs": "EOC_random_enchant_set_flag_before" },
            { "math": [ "u_random_enchant_set_flag_success", "=", "0" ] },
            {
              "u_run_inv_eocs": "manual",
              "title": "対象は？",
              "true_eocs": [
                {
                  "id": "EOC_random_enchant_enchant_crystal_run",
                  "condition": { "not": { "npc_has_flag": "random_enchant_ALREADY_ENCHANT" } },
                  "effect": [
                    { "math": [ "u_random_enchant_set_flag_success", "=", "1" ] },
                    { "npc_set_flag": "random_enchant_ALREADY_ENCHANT" },
                    { "run_eocs": "EOC_random_enchant_set_flag_after" }
                  ],
                  "false_effect": { "u_message": "すでにエンチャントされている。" }
                }
              ]
            },
            {
              "if": { "math": [ "u_random_enchant_set_flag_success", "==", "1" ] },
              "then": { "npc_set_flag": "random_enchant_USED" }
            }
          ],
          "false_effect": { "u_message": "使用済です。" }
        }
      ]
    }
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_random_enchant_set_flag_before",
    "effect": [
      { "set_string_var": "null", "target_var": { "u_val": "random_enchant_f_1" } },
      { "set_string_var": "null", "target_var": { "u_val": "random_enchant_f_2" } },
      { "set_string_var": "null", "target_var": { "u_val": "random_enchant_f_3" } },
      {
        "foreach": "array",
        "var": { "context_val": "tmp" },
        "target": [ "_f_1", "_f_2", "_f_3" ],
        "effect": [
          { "math": [ "_found", "=", "0" ] },
          {
            "foreach": "ids",
            "var": { "context_val": "id" },
            "target": "flag",
            "effect": [
              {
                "if": {
                  "and": [
                    { "math": [ "_found", "==", "0" ] },
                    { "npc_has_flag": { "context_val": "id" } },
                    { "not": { "compare_string": [ { "context_val": "f_1" }, { "context_val": "id" } ] } },
                    { "not": { "compare_string": [ { "context_val": "f_2" }, { "context_val": "id" } ] } },
                    { "not": { "compare_string": [ { "context_val": "f_3" }, { "context_val": "id" } ] } }
                  ]
                },
                "then": [
                  { "math": [ "_found", "=", "1" ] },
                  { "set_string_var": { "context_val": "id" }, "target_var": { "var_val": "tmp" } }
                ]
              }
            ]
          }
        ]
      },
      { "set_string_var": { "context_val": "f_1" }, "target_var": { "u_val": "random_enchant_f_1" } },
      { "set_string_var": { "context_val": "f_2" }, "target_var": { "u_val": "random_enchant_f_2" } },
      { "set_string_var": { "context_val": "f_3" }, "target_var": { "u_val": "random_enchant_f_3" } }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "EOC_random_enchant_set_flag_after",
    "effect": [
      {
        "if": { "not": { "compare_string": [ { "u_val": "random_enchant_f_1" }, "null" ] } },
        "then": [ { "npc_set_flag": { "u_val": "random_enchant_f_1" } } ]
      },
      {
        "if": { "not": { "compare_string": [ { "u_val": "random_enchant_f_2" }, "null" ] } },
        "then": [ { "npc_set_flag": { "u_val": "random_enchant_f_2" } } ]
      },
      {
        "if": { "not": { "compare_string": [ { "u_val": "random_enchant_f_3" }, "null" ] } },
        "then": [ { "npc_set_flag": { "u_val": "random_enchant_f_3" } } ]
      }
    ]
  }
]
